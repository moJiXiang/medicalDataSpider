

import time
from scrapy.spiders import Spider
from scrapy_splash import SplashRequest, request
from scrapy_splash.utils import parse_x_splash_saved_arguments_header
from medicalDataSpider.items import ArticleItem, BaikeItem, WendaAskItem, WendaReplayItem

lua_script = '''
function main(splash, args)
    splash:go(splash.args.url)
    splash:wait(2)

    return splash:html()
end
'''


class BaiduBaikeSpider(Spider):
    # 爬虫名称
    name = "baidu_baike_spider"
    keyword = ""
    keywordList = [
        "试管婴儿费用",
        "试管婴儿移植后注意事项",
        "人工授精和试管婴儿区别",
        "黄体期",
        "nt检查",
        "取卵流程",
        "降调",
        "卵泡监测",
        "爱乐维复合维生素片",
        "绒毛膜促性腺激素",
        "排卵试纸强阳",
        "怎么生双胞胎",
        "hcg正常值",
        "雌激素低怎么办",
        "多胎妊娠",
        "ICSI",
        "试管婴儿移植后症状",
        "试管婴儿移植后饮食",
        "试管婴儿移植后感觉",
        "试管婴儿移植后反应",
        "第一代试管婴儿(IVF)",
        "第二代试管婴儿(ICSI)",
        "安徽试管婴儿",
        "A卵B怀",
        "阿司匹林",
        "阿法林润康",
        "艾泽",
        "爱乐维",
        "安全期",
        "AMH",
        "安抚奶嘴",
        "北京试管婴儿",
        "不排卵",
        "北医三院",
        "北京协和医院",
        "碧萝芷",
        "八珍丸",
        "勃锐精",
        "补佳乐",
        "贝依",
        "倍美力",
        "八珍汤",
        "补中益气汤",
        "闭经",
        "备孕",
        "B超检查",
        "病毒疹",
        "白细胞",
        "背奶",
        "保胎",
        "丙肝",
        "哺乳期",
        "避孕方法",
        "避孕膜",
        "避孕药",
        "宝宝长牙",
        "宝宝鞋",
        "宝宝金水",
        "宝宝打嗝",
        "不孕不育",
        "成都试管婴儿",
        "促排卵",
        "促排卵药物",
        "长方案",
        "超长方案",
        "巢倍滋",
        "参茸保胎丸",
        "醋酸加尼瑞克",
        "催乳汤",
        "残角子宫",
        "蚕豆病",
        "促卵泡激素",
        "促黄体生成素",
        "测孕纸",
        "催经",
        "产后",
        "产后护理",
        "产后抑郁症",
        "产后恶露",
        "催产",
        "长沙试管婴儿",
        "长春试管婴儿",
        "雌二醇",
        "出生证明",
        "产假",
        "产检建卡",
        "第二代试管婴儿",
        "第三代试管婴儿",
        "第四代试管婴儿",
        "冻胚移植",
        "短方案",
        "地中海贫血",
        "大豆异黄酮",
        "达芙通",
        "达必佳",
        "dhea",
        "达英35",
        "dha",
        "单角子宫",
        "多囊卵巢",
        "低压高",
        "待产期",
        "断奶",
        "单身",
        "东莞试管婴儿",
        "达菲林",
        "调经促孕丸",
        "俄罗斯试管婴儿",
        "俄罗斯试管婴儿医院",
        "俄罗斯试管婴儿费用",
        "俄罗斯试管婴儿攻略",
        "二仙汤",
        "二胎",
        "儿童肥胖",
        "福建试管婴儿",
        "芬吗通",
        "辅酶Q10",
        "番茄红素",
        "封闭抗体",
        "赴美生子",
        "分娩",
        "佛山试管婴儿",
        "福州试管婴儿",
        "格鲁吉亚试管婴儿",
        "广西试管婴儿",
        "广东试管婴儿",
        "贵州试管婴儿",
        "甘肃试管婴儿",
        "广州试管婴儿",
        "高龄试管婴儿",
        "供卵试管婴儿",
        "睾丸片",
        "果纳芬",
        "固肾安胎丸",
        "鸽子汤",
        "宫腔粘连",
        "弓形子宫",
        "肝火旺",
        "宫腔镜",
        "宫寒",
        "睾酮",
        "甘胆酸",
        "谷草转氨酶",
        "隔代教育",
        "宫外孕",
        "高龄孕妇",
        "高龄备孕",
        "弓形虫",
        "贵阳试管婴儿",
        "供精",
        "湖南试管婴儿",
        "湖北试管婴儿",
        "黑龙江试管婴儿",
        "河北试管婴儿",
        "海南试管婴儿",
        "黄体期促排方案",
        "贺美奇",
        "hmg",
        "黑鱼汤",
        "好孕汤",
        "海参小米粥",
        "婚检",
        "HCG",
        "黄体酮",
        "红细胞",
        "护脐贴",
        "怀孕",
        "hpv疫苗",
        "HIV洗精",
        "黄疸",
        "河南试管婴儿",
        "杭州试管婴儿",
        "合肥试管婴儿",
        "哈尔滨试管婴儿",
        "海口试管婴儿",
        "呼和浩特试管婴儿",
        "混血儿",
        "柬埔寨试管婴儿",
        "江西试管婴儿",
        "江苏试管婴儿",
        "吉林试管婴儿",
        "降调",
        "拮抗剂方案",
        "监测卵泡",
        "精子",
        "精子库",
        "精子活力",
        "基础卵泡",
        "精子碎片率",
        "金凤丸",
        "肌醇",
        "精氨酸",
        "鸡血汤",
        "绝经",
        "监测排卵",
        "甲胎蛋白",
        "巨细胞病毒",
        "假性怀孕",
        "畸胎瘤",
        "建大卡",
        "节育环",
        "巨大儿",
        "济南试管婴儿",
        "精子分离术",
        "结婚证",
        "基础代谢率",
        "畸形精子",
        "建小卡",
        "空卵泡",
        "克罗米芬",
        "凯妮汀",
        "克龄蒙",
        "凯格尔运动",
        "昆明试管婴儿",
        "冷冻卵子",
        "辽宁试管婴儿",
        "卵泡",
        "卵子质量",
        "卵泡破裂",
        "卵泡发育",
        "卵泡不破",
        "卵泡萎缩",
        "来曲唑片",
        "乐宝得",
        "林卡尔",
        "丽申宝",
        "亮丙瑞林",
        "利维爱",
        "卵巢",
        "卵巢早衰",
        "卵巢破裂",
        "卵巢囊肿",
        "流感疫苗",
        "罗圈腿",
        "兰州试管婴儿",
        "拉萨试管婴儿",
        "龙凤胎",
        "美国试管婴儿",
        "美国试管婴儿费用",
        "美国试管婴儿医院",
        "美国试管婴儿攻略",
        "马来西亚试管婴儿",
        "美卓乐",
        "美欣乐",
        "酶免法",
        "泌乳素",
        "麻风疫苗",
        "梅毒",
        "囊胚移植",
        "内膜薄",
        "内膜厚",
        "内膜异位症",
        "能不能吃",
        "nk细胞",
        "尿布疹",
        "南京试管婴儿",
        "南宁试管婴儿",
        "南昌试管婴儿",
        "诺雷得",
        "nt检查",
        "胚胎发育",
        "胚胎等级",
        "胚胎移植",
        "排卵障碍",
        "培坤丸",
        "普丽康",
        "排卵试纸",
        "排卵期",
        "陪护假",
        "盆腔结核",
        "剖腹产",
        "青海试管婴儿",
        "取卵",
        "强的松",
        "麒麟丸",
        "前白蛋白",
        "亲子育儿",
        "取环",
        "清宫表",
        "前置胎盘",
        "清宫手术",
        "脐带绕颈",
        "巧克力囊肿",
        "呛奶",
        "青岛试管婴儿",
        "取精",
        "取卵后腹水",
        "人工授精",
        "日本试管婴儿",
        "染色体",
        "染色体异常",
        "绒毛穿刺",
        "妊娠月经",
        "妊娠纹",
        "染色体缺失",
        "妊娠糖尿病",
        "试管婴儿",
        "试管婴儿费用",
        "试管婴儿成功率",
        "试管婴儿医院",
        "试管婴儿流程",
        "双胞胎",
        "试管婴儿移植后",
        "试管婴儿移植前",
        "试管婴儿包成功",
        "上海试管婴儿",
        "四川试管婴儿",
        "陕西试管婴儿",
        "山西试管婴儿",
        "山东试管婴儿",
        "死精症",
        "少精弱精",
        "上海集爱",
        "山大生殖",
        "生精片",
        "思则凯",
        "生化汤",
        "四物汤",
        "十全大补汤",
        "四君子汤",
        "水鱼汤",
        "四红补血粥",
        "始基子宫",
        "输卵管",
        "输卵管造影",
        "输卵管堵塞",
        "输卵管切除",
        "肾积水",
        "肾盂分离",
        "四维彩超",
        "试管婴儿医生",
        "三伏贴",
        "生男生女",
        "生化妊娠",
        "水痘疫苗",
        "缩阴",
        "试管婴儿成功日记",
        "深圳试管婴儿",
        "苏州试管婴儿",
        "沈阳试管婴儿",
        "石家庄试管婴儿",
        "失独家庭",
        "受精卵",
        "生育险",
        "少儿身份证",
        "SCRC",
        "泰国试管婴儿",
        "泰国试管婴儿费用",
        "泰国试管婴儿医院",
        "泰国试管婴儿攻略",
        "台湾试管婴儿",
        "天津试管婴儿",
        "同性恋试管婴儿",
        "唐氏综合征",
        "唐氏筛查",
        "天喜堂天喜丸",
        "糖类抗原",
        "铁蛋白",
        "头盆不称",
        "胎盘早剥",
        "胎梦",
        "胎停育",
        "胎心仪",
        "胎心率",
        "胎儿窘迫",
        "胎心监护",
        "胎位",
        "痛经",
        "兔唇",
        "吐奶",
        "太原试管婴儿",
        "乌克兰试管婴儿",
        "乌克兰试管婴儿费用",
        "乌克兰试管婴儿医院",
        "乌克兰试管婴儿攻略",
        "微刺激方案",
        "无精症",
        "五红汤",
        "无子宫",
        "喂药器",
        "武汉试管婴儿",
        "乌鲁木齐试管婴儿",
        "温州试管婴儿",
        "未婚生子",
        "无创dna",
        "香港试管婴儿",
        "鲜胚移植",
        "血友病",
        "欣妈富隆",
        "溴隐亭",
        "雪诺同",
        "性激素六项",
        "血沉",
        "血尿素氮",
        "血常规",
        "血红蛋白",
        "性别鉴定",
        "先兆流产",
        "习惯性流产",
        "小月子",
        "稀有血型",
        "新生儿",
        "小儿包茎",
        "学步带",
        "新生儿湿肺",
        "新生儿睡姿",
        "学饮杯",
        "西安试管婴儿",
        "厦门试管婴儿",
        "西宁试管婴儿",
        "新生儿上户",
        "下奶",
        "云南试管婴儿",
        "养囊",
        "夜针",
        "优势卵泡",
        "遗传病",
        "优甲乐",
        "乙烯雌酚",
        "依诺肝素钠",
        "优思明",
        "益母草蜂蜜",
        "养肝汤",
        "阳和汤",
        "幼稚子宫",
        "孕前检查",
        "羊水",
        "羊水穿刺",
        "乙肝五项",
        "月经提前",
        "孕酮",
        "月经杯",
        "孕早期",
        "孕中期",
        "孕晚期",
        "孕妇胃疼",
        "预产期",
        "孕妇睡姿",
        "乙脑疫苗",
        "叶酸片",
        "婴儿奶粉",
        "婴儿腹泻",
        "婴儿床",
        "婴儿湿疹",
        "银川试管婴儿",
        "验孕",
        "月经不调",
        "浙江试管婴儿",
        "重庆试管婴儿",
        "着床",
        "自然周期",
        "中信湘雅",
        "滋肾育胎丸",
        "子宫畸形",
        "子宫腺肌症",
        "子宫问题",
        "纵隔子宫",
        "子宫切除",
        "子宫肌瘤",
        "子宫前位",
        "子宫内膜",
        "总胆汁酸",
        "坐月子",
        "子宫帽",
        "攒肚子",
        "准生证",
        "助孕",
        "郑州试管婴儿"
    ]

    def __init__(self, keyword="", **kwargs):
        self.keyword = keyword
        self.index_url = f'https://baike.baidu.com/item/{keyword}'

        super().__init__(**kwargs)

    def start_requests(self):
        for keyword in self.keywordList:
            time.sleep(10)
            url = 'https://baike.baidu.com/item/{keyword}'.format(
                keyword=keyword)
            yield SplashRequest(url, self.parse, endpoint="execute", args={'lua_source': lua_script, 'wait': 1}, meta={'origin_url': url, "keyword": keyword})

    def parse(self, response):
        wiki = response.xpath("//body[contains(@class, 'wiki-lemma')]")
        if wiki:
            item = BaikeItem()
            item["tagName"] = response.meta["keyword"]
            item["source"] = response.meta["origin_url"]
            if response.xpath("//meta[@name='keywords']"):
                item["keyword"] = response.xpath(
                    "//meta[@name='keywords']/@content").extract()[0]
            else:
                item["keyword"] = response.meta["keyword"]
            item["title"] = response.xpath(
                "//dd[@class='lemmaWgt-lemmaTitle-title']//h1//text()").extract()[0].strip()
            item["description"] = response.xpath(
                "string(//div[@class='lemma-summary'])").extract()[0].strip()
            paradivs = response.xpath(
                "//div[contains(@class, 'main-content')]/div[contains(@class, 'para-title') or contains(@class, 'para')]")

            text = []
            images = []
            for div in paradivs:
                t = div.xpath(
                    "string()").extract()[0].strip()
                text.append(t)

                imgs = div.xpath(".//img/@src").extract()
                for img in imgs:
                    if img.find("http") >= 0:
                        images.append(img)

            item["content"] = "<br>".join(text)
            vote_tag = response.xpath("//span[@class='vote-count']")

            if vote_tag:
                item["likes"] = response.xpath(
                    "//span[@class='vote-count']//text()").extract()[0]
            else:
                item["likes"] = response.xpath(
                    "//i[@class='vote-count']//text()").extract()[0]

            item["images"] = images
            item["visits"] = response.xpath(
                "//span[@id='j-lemmaStatistics-pv']//text()").extract()[0]

            yield item
